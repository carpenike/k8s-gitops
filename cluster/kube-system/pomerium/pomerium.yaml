---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: pomerium
  namespace: kube-system
spec:
  releaseName: pomerium
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://helm.pomerium.io
      chart: pomerium
      version: 14.0.0
      sourceRef:
        kind: HelmRepository
        name: pomerium-charts
        namespace: flux-system
      interval: 5m
  values:
    image:
      repository: pomerium/pomerium
      tag: v0.12.1
    ingress:
      enabled: true
      secretName: pomerium-cert
      authenticate:
        name: authenticate
      annotations:
        nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
        kubernetes.io/tls-acme: "true"
        cert-manager.io/cluster-issuer: "letsencrypt-prod"
      hosts:
        - sonarr.holthome.net
        - radarr.holthome.net
        # - esphome.holthome.net
        - sabnzbd.holthome.net
      tls:
        hosts:
          - sonarr.holthome.net
          - radarr.holthome.net
          # - esphome.holthome.net
          - sabnzbd.holthome.net
    forwardAuth:
      enabled: true
      internal: false
    operator:
      enabled: false
      replicaCount: 1
      image:
        repository: pomerium/pomerium-operator
        tag: "20210118224248"
      config:
        ingressClass: pomerium
        serviceClass: pomerium
    config:
      rootDomain: holthome.net
      #administrators: "ryan@ryanholt.net"
      policy:
        # - from: https://httpbin.holthome.net
        #   to: http://httpbin.default.svc.cluster.local:8000
        #   allowed_groups:
        #     - k8s-admins
        # Sonarr
        - from: https://sonarr.holthome.net
          to: http://sonarr.default.svc.cluster.local:8989
          prefix: /api/
          allow_public_unauthenticated_access: true
          allow_websockets: true
        - from: https://sonarr.holthome.net
          to: http://sonarr.default.svc.cluster.local:8989
          allowed_groups:
            - k8s-admins
        # Radarr
        - from: https://radarr.holthome.net
          to: http://radarr.default.svc.cluster.local:7878
          prefix: /api/
          allow_public_unauthenticated_access: true
          allow_websockets: true
        - from: https://radarr.holthome.net
          to: http://radarr.default.svc.cluster.local:7878
          allowed_groups:
            - k8s-admins
        # Radarr-uhd
        - from: https://radarr-uhd.holthome.net
          to: http://radarr-uhd.default.svc.cluster.local:7878
          prefix: /api/
          allow_public_unauthenticated_access: true
          allow_websockets: true
        - from: https://radarr-uhd.holthome.net
          to: http://radarr-uhd.default.svc.cluster.local:7878
          allowed_groups:
            - k8s-admins
        # Sabnzbd
        - from: https://sabnzbd.holthome.net
          to: http://sabnzbd.default.svc.cluster.local:8080
          prefix: /api/
          allow_public_unauthenticated_access: true
          allow_websockets: true
        - from: https://sabnzbd.holthome.net
          to: http://sabnzbd.default.svc.cluster.local:8080
          allowed_groups:
            - k8s-admins
        # ESPHome
        - from: https://esphome.holthome.net
          to: http://esphome.default.svc.cluster.local:6052
          allow_public_unauthenticated_access: false
          allowed_groups:
            - k8s-admins
        # GAPS
        - from: https://gaps.holthome.net
          to: http://gaps.default.svc.cluster.local:8484
          allowed_groups:
            - k8s-admins
      #   - from: https://ha-vscode.holthome.net
      #     to: http://home-assistant.default.svc.cluster.local:80
      #     allow_websockets: true
      #     allowed_groups:
      #       - k8s-admins
      #   Longhorn
      #   - from: https://longhorn.holthome.net
      #     to: http://longhorn-frontend.longhorn-system.svc.cluster.local:80
      #     allow_websockets: true
      #     allowed_groups:
      #       - k8s-admins
    # proxy:
    #   authenticateServiceUrl: https://authenticate.holthome.net
    metrics:
      enabled: true
    serviceMonitor:
      enabled: true
    # resources:
    #   requests:
    #     memory: 350Mi
    #     cpu: 25m
    #   limits:
    #     memory: 500Mi
  valuesFrom:
    - kind: Secret
      name: "pomerium-helm-values"
